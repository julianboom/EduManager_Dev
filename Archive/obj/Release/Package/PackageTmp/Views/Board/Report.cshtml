@using Model;
@{
    Layout = null;
    NoticeBoard item = ViewBag.NoticeBoard;

}
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    @RenderPage("~/Views/Share/bootstrap.cshtml")
    <script src="~/Web/guid.js"></script>


</head>
    <body>
        <div class="mySearch">
            <div class="row">
                <div class="col-md-12" style="padding:10px 0px">
                    <div class="row">
                           <div class="col-xs-1">
                                 <button type="button" class="layui-btn layui-btn-normal " onclick="BoardCreate()"  style="float:left;">发布公告</button>
                            </div>
                        
                            <div class="col-xs-1">
                                <label>标题：</label>
                            </div>

                            <div class="col-xs-2">
                                <input autocomplete = "off" type="text" name="Title" id="qry_Title" class="form-control" />
                            </div>
                        <div class="col-xs-1">
                            <label>关键词：</label>
                        </div>

                        <div class="col-xs-2">
                            <input autocomplete = "off" type="text" name="Title" id="qry_Keyword" class="form-control" />
                        </div>
                        <div class="col-xs-1">
                            <label>文号：</label>
                        </div>

                        <div class="col-xs-2">
                            <input autocomplete = "off" type="text" name="Title" id="qry_DocNo" class="form-control" />
                        </div>
                            <div class="col-xs-2">
                                <button class="layui-btn layuiadmin-btn-list" onclick="queryDataGrid()">
                                    <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                                </button>
                                <button class="layui-btn layui-btn-primary layuiadmin-btn-list" onclick="myClear()">
                                    <i class="layui-icon layui-icon-refresh-1 layuiadmin-button-btn"></i>
                                </button>
                            </div>
                        </div>
                    
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div style="width:100%;">
                    <table id="BoardList_table" class="table table-striped table-no-bordered table-hover"></table>
                </div>
            </div>
        </div>
            
        
        <!--添加编辑界面-->
        <div  id="EditBoard" style="display:none">
        
                            
                            <form class="form-horizontal form-bordered form-row-strippe" id="Report_Edit" action="" data-toggle="validator" enctype="multipart/form-data">

    <div class="row">
        <div class="col-xs-1">
            <label class="margin-5 margin-top-10">发布单位：</label>
        </div>
        <div class="col-xs-9 margin-top-10">
            <input autocomplete = "off" type="text" name="ReportUnit" required value="" id="ReportUnit" class="form-control" />
        </div>
    </div>
    <div class="row">
        <input autocomplete = "off" type="hidden" name="ID" id="KeyItemID" />

        <div class="col-xs-1">
            <label class="margin-5 margin-top-10">发布时间：</label>
        </div>
        <div class="col-xs-9 margin-top-10">
            <input autocomplete = "off" class="form-control" required placeholder="发布时间" id="ReportTime" name="ReportTime">
        </div>

    </div>
    <div class="row">
        <div class="col-xs-1">
            <label class="margin-5 margin-top-10">标题：</label>
        </div>
        <div class="col-xs-9 margin-top-10">
            <input autocomplete = "off" type="text" name="ReportTitle" required value="" id="ReportTitle" class="form-control" />
        </div>
    </div>

    <div class="row">
      
        <div class="col-xs-1">
            <label class="margin-5 margin-top-10">类型：</label> <!--公告类型  select2  !!!-->
        </div>
        <div class="col-xs-9 margin-top-10">
            <select id="Type" required class="form-control select2-arrow" name="Type">
                <option value=""></option>

                <option value="1">重要精神讲话内容</option>
                <option value="2">基层党员学习交流</option>
                <option value="3">党章法规知识库</option>


            </select>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-1">
            <label class="margin-5 margin-top-10">文号：</label>

        </div>
        <div class="col-xs-9 margin-top-10">
            <input autocomplete = "off" type="text" required id="DocNo" name="DocNo" class="form-control">
        </div>
    </div>
    <div class="row">
        <div class="col-xs-1">
            <label class="margin-5 margin-top-10">关键词：</label>

        </div><div class="col-xs-9 margin-top-10">
                  <input autocomplete = "off" type="text" required id="Keyword" name="Keyword" class="form-control">
        </div>
    </div>
    <!--文件上传-->
                                <div style="margin:0 15px">
                                    <div class="row">
                                        <div class="col-md-12 margin-top-10" style="margin-top:30px;">
                                            <label style="float:left"></label>
                                        </div>
                                    </div>
                                    <div class="row">

                                        <div class="col-md-1 margin-top-10">
                                            <input autocomplete = "off" id="KeyItemfile_upload" name="KeyItemfile_upload" type="file" multiple="true" />
                                        </div>
                                        <div class="col-md-2 margin-top-10">
                                            <a class="layui-btn " id="KeyItem_btnUpload" href="javascript:KeyItem_checkQueue()">上传</a>
                                            <a class="layui-btn " id="KeyItem_btnCancelUpload" data-options="iconCls:'icon-cancel'" href="javascript:KeyItem_checkCancel()">取消</a>
                                        </div>
                                        <div class="col-md-9 margin-top-10">
                                            <div id="KeyItem_queue"></div>
                                        </div>
                                    </div>
                                    <div class="row">

                                        <div class="col-md-12 margin-top-10">
                                            <div style="width:100%;">
                                                <table id="KeyItemFile_table" class="table table-striped table-no-bordered table-hover"></table>
                                            </div>
                                        </div>
                                    </div>
                                    <br />
                                    <button style="float:right;margin-right:15px" type="button" class="layui-btn layui-btn-normal" onclick="Board_Save()">保存</button>

                                </div>
</form>

                        
                       
                 
                  
            
        </div>
        


    </body>
@RenderPage("~/Views/Share/delConfirm.cshtml")


</html>


<script type="text/javascript">
    var Boardurl = '/Board/GetReportListOwn';

    var list = [];
    var data1 = [];

    var SearchHeight = $(".mySearch").height();

    //$(document).ready(function () {
    //    $.ajax({
    //        url: "/Admin/GetUnitList",
    //        type: "post",
    //        dataType: "json",
    //        contentType: "application/json",
    //        success: function (data) {
    //            //data1.push({ id: data[0].ID, text: data[0].DeptName });
    //            //list = data[0].children;
    //            for (var i = 0; i < data.length; i++) {
    //                var obj = data[i];
    //                var temp = {};

    //                temp.id = obj.ID;
    //                temp.text = obj.UnitName;
    //                data1.push(temp);
    //            }

    //            $("#dept").select2({
    //                data: data1,
    //                placeholder: '请选择部门',//默认文字提示
    //                language: "zh-CN",//汉化
    //                //allowClear: true            //允许清空
    //            });

    //        },
    //        error: function (data) {

    //        }
    //    });

    //    $('#ReportContent').summernote({
    //        height: 300,
    //        focus: true,
    //        lang: 'zh-CN',
    //        toolbar: [
    //            ['style', ['style']],
    //            ['font', ['bold', 'italic', 'underline', 'superscript', 'subscript', 'strikethrough', 'clear']],
    //            ['fontname', ['fontname']],
    //            ['fontsize', ['fontsize']], // Still buggy
    //            ['color', ['color']],
    //            ['para', ['ul', 'ol', 'paragraph']],
    //            ['height', ['height']],
    //            ['table', ['table']],
    //            ['insert', ['link', 'picture', 'video', 'hr']],
    //            ['view', ['fullscreen', 'codeview']],
    //            ['help', ['help']]
    //        ],
    //        callbacks: {
    //            onImageUpload: function (files) {
    //                //上传图片到服务器，使用了formData对象，至于兼容性...据说对低版本IE不太友好
    //                var formData = new FormData();
    //                formData.append('file', files[0]);
    //                $.ajax({
    //                    url: '/ClassFile/up.ashx',//后台文件上传接口
    //                    type: 'POST',
    //                    data: formData,
    //                    processData: false,
    //                    contentType: false,
    //                    success: function (imgUrl) {
    //                        $('#ReportContent').summernote('insertImage', imgUrl, 'img');
    //                    }
    //                });
    //            }
    //        }
    //    });
    //});
    $('#BoardList_table').bootstrapTable({
        url: Boardurl,
        height: $(window).height() - SearchHeight-20,

        title: "发布公告",
        striped: true,
        clickToSelect: true,
        queryParamsType: '',
        pageSize: 10,
        sidePagination: 'server',
        pageList: [10,30, 50],
        pagination: true,     //是否显示分页（*）
        method: 'get',

        columns: [
              {
                  field: 'ReportUnit', title: '发布单位', editable: false, width: 100
              },
            {
                field: 'ReportTime', title: '发布时间', editable: false, width: 100
            },
            {
                field: 'Type', title: '类型', editable: false, width: 100, formatter: function (value, row, index) {

                    if (row.Type == '1')
                        return '<span>重要精神讲话内容</span>';
                    if (row.Type == '2')
                        return '<span>基层党员学习交流</span>';
                    if (row.Type == '3')
                        return '<span>党章规定知识库</span>';
                }
            },
            { field: 'ReportTitle', title: '标题', editable: false, width: 200,halign:"center",align:"left"},
            { field: 'DocNo', title: '文号', editable: false, width: 50 },
                        { field: 'Keyword', title: '关键词', editable: false, width: 50 },

                                    { field: 'ViewCount', title: '浏览量', editable: false, width: 50 },

            { field: '报告内容', title: '操作', width: 100, editable: false, formatter: operateFormatterBoardList },
        ],

        queryParams: function (params) {


            return {
                key1: $('#qry_Keyword').val(),
                key2: $('#qry_DocNo').val(),
                key3: $('#qry_Title').val(),
                pageSize: params.pageSize,
                pageNumber: params.pageNumber
            }
        }
    });
    function operateFormatterBoardList(value, row, index) {
        return [
            '<a  href="javascript:BoardEdit(\'' + row.ID + '\')" id="btn_detail" type="button" class="layui-btn  layui-btn-sm" style="margin-right:20px;">编辑</a>',
            //'<a  href="javascript:KeyItemDetail(\'' + row.ID + '\')" id="btn_detail" type="button" class="layui-btn layui-btn-danger layui-btn-sm" style="margin-right:20px;"><span class="glyphicon glyphicon-pencil"></span>查看</a>',
            '<a  href="javascript:Del_Board(\'' + row.ID + '\')"  type="button" class="layui-btn layui-btn-danger layui-btn-sm">删除</a>',
        ].join('');
    };
    function Del_Board(id) {
        var BoardDeleteUrl = "/Board/Delete?ID=" + id;
        $.ajax({
            type: "post",
            url: "/Board/Delete",
            data: {
                id: id
            },
            success: function (data) {
                alert("删除成功!");
                refeshGridBoard();


            }
        });
    }
    function refeshGridBoard() {
        $('#BoardList_table').bootstrapTable("refresh", { url: Boardurl, pageNumber: 1 });
    }


    function BoardCreate() {
        var guid = Guid.NewGuid().ToString();

        $("#Report_Edit")[0].reset();
        $("#KeyItemID").val(guid);
        KeyItem_upload();
        refeshEditKeyItemFileGrid();
        LayerModalByID("发布", $("#EditBoard"));
    }
    function Board_Save() {
   
        var postData = $("#Report_Edit").serializeArray();
      
        console.log(postData);
        for (var key in postData) {
            if (postData[key].value == '' || postData[key].value == null)
            {
                alert("请填写完整!");
                return;
            }
        }
        $.ajax({
            url: "/Board/SendReport",
            type: "post",
            data: postData,
            success: function (data) {
                refeshGridBoard();
                layer.alert("保存成功", function () {
                    layer.closeAll();

                });
            }
        });


        //$.post('/Board/SendReport', postData, function (data) {
        //    //可增加其他处理
        //    refeshGridBoard();
        //    $("#EditBoard").modal("hide");

        //}).error(function () {
        //});

    };

    function BoardEdit(id) {
        //$('#EditBoard').modal();

        $.ajax({
            type: "POST",
            url: '/Board/Edit',
            data: "ID=" + id,
            dataType: "json",
            success: function (data) {
                console.log(data);
                $("#ReportUnit").val(data.ReportUnit);
                $("#DocNo").val(data.DocNo);
                $("#Keyword").val(data.Keyword);
               

                $("#ReportTime").val(data.ReportTime);
                $("#ReportTitle").val(data.ReportTitle);
                $("#KeyItemID").val(data.ID);

                $("#Type").val(data.Type);

                //$("#dept").val(data.ReportDept).select2();


                KeyItem_upload();
                refeshEditKeyItemFileGrid();
                LayerModalByID(data.ReportTitle,$("#EditBoard"));
            },
            error: function () {
                alert("数据获取失败");
            }
        });
    }


    function KeyItem_upload() {
        var a = 0;
        $('#KeyItemfile_upload').uploadifive({
            'auto': false,
            'fileSizeLimit': '102400KB',
            'buttonText': '浏  览',
            'multi': true,
            'removeCompleted': true,
            'queueID': 'KeyItem_queue',
            'uploadScript': '/File/Upload',
            'formData': { 'ID': $("#KeyItemID").val(), 'type': '公告' },
            'onUploadComplete': function (file, data) {
                a = a + 1;
                if ($("#KeyItem_queue").children().length - a == 0) {
                    a = 0;
                    KeyItem_checkCancel();
                }
            }
        });
    }
    $('#KeyItemFile_table').bootstrapTable({
        method: 'post',
        url: '/File/GetList?ID=' + $("#KeyItemID").val() + '&Type=公告',
        striped: true,
        clickToSelect: true,
        pageSize: 100,
        sidePagination: 'server',
        pageList: [10, 20, 50, 100, 200, 500],
        queryParamsType: 'limit',
        sortName: 'ID',
        sortOrder: 'asc',
        pagination: true,     //是否显示分页（*）

        columns: [
            { field: 'FileName', title: '文件名', width: 200, editable: false, },
            { field: 'opt', title: '操作', width: 100, editable: false, formatter: KeyItemoperateFormatterHandleEdit },
        ],

    });
    function KeyItemoperateFormatterHandleEdit(value, row, index) {
        return [
            '<a  href="/File/Download?ID=' + row.ID + '" id="btn_detail" type="button" class="layui-btn  layui-btn-xs" style="margin-right:20px;">下载</a>',
            '<a  href="javascript:DelKeyItem_File(\'' + row.ID + '\')"  type="button" class="layui-btn layui-btn-danger layui-btn-xs">删除</a>',
        ].join('');
    }
    function DelKeyItem_File(id) {
        $('#id').val(id);//给会话中的隐藏属性URL赋值
        $('#idName').val("ID");
        $('#backMsg').val("KeyItemFile_table");
        $('#urlDel').val("/File/Delete?ID=" + id + "");
        $('#urlBack').val("/File/GetList?ID=" + $("#KeyItemID").val() + "&Type=公告");
        $('#delcfmModel').modal();
    }

    function refeshEditKeyItemFileGrid() {
        $('#KeyItemFile_table').bootstrapTable("refresh", { url: '/File/GetList?ID=' + $("#KeyItemID").val() + '&Type=公告' });
    }
    function KeyItem_checkQueue() {
        if ($("#KeyItem_queue").children().length == 0) {
            alert("请先点击浏览选择要上传的文件！");
        } else {
            $('#KeyItemfile_upload').uploadifive('upload');
        }
    }
    function KeyItem_checkCancel() {
        if ($("#KeyItem_queue").children().length == 0) {
            alert("没有待上传的文件！");
        } else {
            $('#KeyItemfile_upload').uploadifive('clearQueue');
            refeshEditKeyItemFileGrid();
        }
    }

    //function refeshDetailKeyItemFileGrid() {
    //    $('#KeyItemFileDetail_table').bootstrapTable("refresh", { url: '/File/GetList?ID=' + $("#KeyItemID").val() + '&Type=重大事项报告' });
    //}
    function queryDataGrid() {
        $('#BoardList_table').bootstrapTable('refresh', {
            pageNumber: 1,
        })
    }
    function myClear() {
        $('#qry_Title').val("");
        $('#qry_DocNo').val("");
        $('#qry_Keyword').val("");

        queryDataGrid();
    };


    laydate.render({
        elem: "#ReportTime"
    });



</script>