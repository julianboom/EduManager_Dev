@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>

    @RenderPage("~/Views/Share/bootstrap.cshtml")
    <link href="~/Resource/plugins/radio/css/jquery-labelauty.css" rel="stylesheet" />
    <script src="~/Resource/plugins/radio/js/jquery-labelauty.js"></script>
    <script src="~/Resource/plugins/layui/layui.js"></script>
    <link href="~/Resource/plugins/layui/css/layui.css" rel="stylesheet" />
    <style>
        li {
            list-style: none;
        }

        .labelauty-checked, .labelauty-unchecked {
            font-size: 12px !important;
        }

        .dowebok li label {
            padding: 7px 10px !important;
        }
    </style>
</head>
<body style="padding:15px">
    <div class="mySearch">
        <div class="row">
            <div class="col-xs-1">
                <label class="margin-5">姓名：</label>
            </div>
            <div class="col-xs-2">
                <input autocomplete = "off"type="text" name="Name" id="qry_Name" class="layui-input" />
            </div>
            <div class="col-xs-1">
                <label class="margin-5">工作单位：</label>
            </div>
            <div class="col-xs-2">
                <input autocomplete = "off"type="text" name="WorkUnit" id="qry_WorkUnit" class="layui-input" />
            </div>
            <div class="col-xs-1">
                <label class="margin-5">职级：</label>
            </div>
            <div class="col-xs-2">
                <input autocomplete = "off"type="text" name="WorkLevel" id="qry_WorkLevel" class="layui-input" />
            </div>
            <div class="col-xs-1">
                <label class="margin-5">身份证：</label>
            </div>
            <div class="col-xs-2">
                <input autocomplete = "off"type="text" name="WorkLevel" id="qry_IdCard" class="layui-input" />
            </div>
        </div>
        <div class="row" style="margin:10px 0px">
            <div class="col-xs-1">
                <label class="margin-5">数据补全：</label>
            </div>
            <div class="col-xs-2">
                <select id="buquan" class="form-control ">
                    <option value=""></option>
                    <option value="noresume">无个人履历</option>
                    <option value="haveresume">有个人履历</option>
                    <option value="nofamily">无家庭情况</option>
                    <option value="havefamily">有家庭情况</option>
                    <option value="noaudit">无审计报告</option>
                    <option value="haveaudit">有审计报告</option>
                    <option value="noreport">无述廉报告</option>
                    <option value="havereport">有述廉报告</option>
                </select>
            </div>
            <div class="col-xs-1">
                <label class="margin-5">地区/单位：</label>
            </div>
            <div class="col-xs-2">
                <select class="form-control select2-active" style="width:100%" id="qry_Unit"></select>
            </div>
            <div class="col-xs-1">
                <label class="margin-5">分工情况：</label>
            </div>
            <div class="col-xs-2">
                <input autocomplete = "off"type="text" name="WorkCharge" id="qry_WorkCharge" class="layui-input" />
            </div>
            <div class="col-xs-3" style="text-align:right">
                <button class="layui-btn layuiadmin-btn-list" onclick="queryDataGrid()">
                    <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                </button>
                <button class="layui-btn layui-btn-primary layuiadmin-btn-list" onclick="myClear()">
                    <i class="layui-icon layui-icon-refresh-1 layuiadmin-button-btn"></i>
                </button>
            </div>
        </div>
        <div class="row" style="margin:10px 0px">
            <div class="col-xs-1">
                <button type="button" class="layui-btn" onclick="Edit('')"><i class="layui-icon"></i></button>
            </div>

            <div class="col-xs-2" style="padding:0px;">
                <button class="layui-btn" data-toggle="modal" data-target="#myModal1" onclick="clearselect()">基础信息导入</button>
            </div>

            <div class="col-xs-1">
                <input autocomplete = "off"id="file_uploadDaoru" name="file_upload" type="file" multiple="true" />
            </div>
            <div class="col-xs-2" style="padding:0px;">
                <a class="layui-btn layui-btn-primary" id="btnUpload" data-options="iconCls:'icon-save'" href="javascript:checkQueueDaoru()">履历导入</a>
                <a class="layui-btn layui-btn-primary" id="btnCancelUpload" data-options="iconCls:'icon-cancel'" href="javascript:checkCancelDaoru()">取消</a>
            </div>
            <div class="col-xs-1" style="margin: 0px 0px 10px 0px">
                <input autocomplete="off" id="file_uploadFamliy" name="file_upload" type="file" multiple="true" />
            </div>
            <div class="col-xs-2" style="padding: 0px; margin: 0px 0px 10px 0px">
                <a class="layui-btn layui-btn-primary" id="btnUploadFamliy" data-options="iconCls:'icon-save'" href="javascript:checkQueueFamliy()">家庭信息导入</a>
                <a class="layui-btn layui-btn-primary" id="btnCancelUploadFamliy" data-options="iconCls:'icon-cancel'" href="javascript:checkCancelFamliy()">取消</a>
            </div>
            <div>
                <div class="col-xs-3">
                    <div id="queueDaoru" style="margin-top: 0px 0px 0px 10px; width: 100%; position: relative; display: inline-block"></div>
                    <div id="queueFamliy" style=" width: 100%; position: relative; display: inline-block;"></div>

                </div>
            </div>

        </div>

    </div>

    <div>
        <table id="PersonList_table"  class="table table-striped table-no-bordered table-hover"></table>
    </div>
    <div id="pageNamber1" style="position:absolute;bottom:20px;text-align:center;right:300px;display:none">
        <label style="font-weight:500">跳转到</label>
        <input autocomplete = "off"value="1" id="pageNamber" class="layui-input" style="width:40px;text-align:center;height:30px;display:inline-block" />
        <label style="font-weight:500">页</label>
    </div>
    @RenderPage("~/Views/Share/delConfirm.cshtml")
    <div id="myMasks">
        <div id="ai" style="position: relative; border-radius: 10px; width: 250px; height: 100px; margin-left: auto; margin-right: auto; margin-top: 10px; background-color: rgba(0,0,0,0.4); padding: 20px; }">
            <div id="foo" style="float:left; width: auto; height: auto; margin-top: 12px; margin-top: 28px; margin-left: 25px; "></div>
            <label id="myMasksText" style="color: #fff; font-size: 18px; float: left; margin-left: 40px;  margin-top: 15px; ">正在导入，请稍等</label>
        </div>
    </div>
    <div class="modal fade" id="diejia" style="padding-top:20px;background-color:rgba(0,0,0,0.0);">
        <button style="position: fixed; right: 0px;width: 50px;height: 50px;border-radius: 50%;background-color: #ffffff;color: #000000;" type="button" class="close" onclick="myclose()">
            <span aria-hidden="true" style="font-size:26px">×</span>
        </button>
        <iframe id="diejiayemian" style="border:none;" width="100%" height="98%" src=""></iframe>
    </div>

    <div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">基础信息导入</h4>
                </div>
                <div class="modal-body">


                    <div class="row">
                        <div class="col-xs-12">
                            <select class="form-control select2-active" style="width:100%" id="UnitSelect"></select>
                        </div>

                    </div>
                    <div class="row margin-top-10">
                        <div class="layui-upload">
                            <button type="button" class="layui-btn layui-btn-normal" id="testList">选择文件</button>
                            <span style="margin-left:10px" id="result"></span>

                            <div class="layui-upload-list">
                                <table class="layui-table">
                                    <thead>
                                        <tr>
                                            <th>文件名</th>
                                            <th>大小</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>

                                    </thead>
                                    <tbody id="demoList"></tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="layui-btn layui-btn-primary" data-dismiss="modal">关闭</button>
                    <button type="button" class="layui-btn" id="testListAction">开始上传</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>


</body>
</html>

<script type="text/javascript">
    var windowHeight = $(window).height();

    var SearchHeight = $(".mySearch").height();
    $('#PersonList_table').bootstrapTable({
        height: $(window).height() - SearchHeight-60,
        url: '/Person/GetIncorruptibleList',
        method: 'get',
        toolbar: '#toolbar',    //工具按钮用哪个容器
        striped: true,      //是否显示行间隔色
        smartDisplay: true,
        cache: false,      //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
        pagination: true,     //是否显示分页（*）
        sortable: true,      //是否启用排序
        sortName:"Sequence",
        sortOrder: "asc",     //排序方式
        pageNumber: 1,      //初始化加载第一页，默认第一页
        pageSize: 100,      //每页的记录行数（*）
        pageList: [10, 25, 50, 100],  //可供选择的每页的行数（*）
        queryParamsType: '', //默认值为 'limit' ,在默认情况下 传给服务端的参数为：offset,limit,sort
        // 设置为 ''  在这种情况下传给服务器的参数为：pageSize,pageNumber
        //queryParams: queryParams,//前端调用服务时，会默认传递上边提到的参数，如果需要添加自定义参数，可以自定义一个函数返回请求参数
        sidePagination: "server",   //分页方式：client客户端分页，server服务端分页（*）
        //search: true,      //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
        strictSearch: true,
        //showColumns: true,     //是否显示所有的列
        //showRefresh: true,     //是否显示刷新按钮
        minimumCountColumns: 2,    //最少允许的列数
        clickToSelect: true,    //是否启用点击选中行
        queryParams: function (params) {
            return {
                sort: params.sortName,
                order: params.sortOrder,
                keyword1: $('#qry_Name').val(),
                keyword2: $('#qry_WorkUnit').val(),
                keyword3: $('#qry_WorkLevel').val(),
                keyword4: $('#qry_IdCard').val(),
                keyword5: $('#qry_Unit').val(),
                WorkCharge: $('#qry_WorkCharge').val(),
                buquan: $("#buquan").val(),
                //File: $("input[type=checkbox]:checked").length <= 0 ? "" : $("input[type=checkbox]:checked").val(),
                pageSize: params.pageSize,
                pageNumber: params.pageNumber,
            }
        },
        columns: [
            { field: 'Name', title: '姓名', width: 50, editable: false, formatter: IfEmpty, sortable: true },
            { field: 'WorkUnit', title: '工作单位', width: 100, editable: false, align: 'left', formatter: IfEmpty, sortable: true},
            { field: 'WorkDuty', title: '职务', width: 100, editable: false, align: 'left', formatter: IfEmpty, sortable: true},
            { field: 'WorkLevel', title: '职级', width: 50, editable: false, sortable: true},
        { field: 'IdCard', title: '身份证', width: 50, editable: false,sortable: true },
            { field: 'opt', title: '操作', width: 50, editable: false, formatter: operateFormatterPerson },
        ],
    });
    $('table').on('load-success.bs.table', function (data) {
        console.log("load success");
        $("[data-toggle='tooltip']").tooltip();
        var a = $('table').bootstrapTable('getData');
        //console.log(a);
        if (a.length > 0) {
            $("#pageNamber1").css("display", "block");
        }
    });

    function operateFormatterPerson(value, row, index) {
        return [
            '<a  href="javascript:Edit(\'' + row.ID + '\')" id="btn_detail" type="button" class="layui-btn layui-btn-sm" style="margin-right:10px">编辑</a>',
            '<a  href="javascript:deleteByID(\'' + row.ID + '\')" id="btn_detail" type="button" class="layui-btn layui-btn-sm layui-btn-danger" style="margin-right:10px">删除</a>',
        ].join('');
    }
    function queryDataGrid() {
        $('#PersonList_table').bootstrapTable('refresh', {
            pageNumber: 1,
        });
    }



    function myClear() {
        $('#qry_Name').val("");
        $('#qry_WorkUnit').val("");
        $('#qry_WorkLevel').val(""),
        $('#qry_IdCard').val(""),
        $("#buquan").val(""),
        clearselect();
        queryDataGrid();
    };
    //function Create() {
    //    window.location.href = "/Person/PersonCreate";
    //}

    function deleteByID(id) {
        $('#id').val(id);//给会话中的隐藏属性URL赋值
        $('#idName').val("ID");
        $('#backMsg').val("PersonList_table");
        $('#urlDel').val("/Person/Delete");
        $('#urlBack').val("/Person/GetPersonList");
        $('#delcfmModel').modal();
    }

    function checkQueue() {
        if ($("#queue").children().length == 0) {
            alert("请先点击浏览选择要上传的文件！");
        } else {
            loading();
            $('#file_upload').uploadifive('upload');
        }
    }
    function checkCancel() {
        if ($("#queue").children().length == 0) {
            alert("没有待上传的文件！");
        } else {
            $('#file_upload').uploadifive('clearQueue');
            queryDataGrid();
        }
    }

    $(function () {
        var a = 0;
        $('#file_upload').uploadifive({
            'auto': false,
            'fileSizeLimit': '102400KB',
            'buttonText': '浏  览',
            'multi': true,
            'queueID': 'queue',
            'uploadScript': '/Person/PersonUpload',
            'formData': { 'ID': '@*@item.ID*@', 'type': 'Person' },
            'onUploadComplete': function (file, data) {
                a = a + 1;
                if ($("#queue").children().length - a == 0) {
                    checkCancel();
                    a = 0;
                }
                unload();
            }
        });
        $("#pageNamber").change(function () {
            $('table').bootstrapTable('refresh', {
                pageNumber: $("#pageNamber").val(),
            });
        })
        $('input[type=checkbox]').labelauty();
    });
    function checkQueueDaoru() {
        if ($("#queueDaoru").children().length == 0) {
            alert("请先点击浏览选择要上传的文件！");
        } else {
            loading();
            $('#file_uploadDaoru').uploadifive('upload');
        }
    }
    function checkCancelDaoru() {
        if ($("#queueDaoru").children().length == 0) {
            alert("没有待上传的文件！");
        } else {
            $('#file_uploadDaoru').uploadifive('clearQueue');
        }
    }

    $(function () {
        var a = 0;
        $('#file_uploadDaoru').uploadifive({
            'auto': false,
            'fileSizeLimit': '102400KB',
            'buttonText': '浏  览',
            'multi': true,
            'queueID': 'queueDaoru',
            'uploadScript': '/Person/ResumeUpload',
            'formData': { 'ID': '@*@item.ID*@', 'type': 'ResumeInsert' },
            'onUploadComplete': function (file, data) {
                a = a + 1;
                if ($("#queueDaoru").children().length - a == 0) {
                    checkCancelDaoru();
                    a = 0;
                }
                unload();
            }
        });
    });
    //
    function checkQueueFamliy() {
        if ($("#queueFamliy").children().length == 0) {
            alert("请先点击浏览选择要上传的文件！");
        } else {
            loading();
            $('#file_uploadFamliy').uploadifive('upload');
        }
    }
    function checkCancelFamliy() {
        if ($("#queueFamliy").children().length == 0) {
            alert("没有待上传的文件！");
        } else {
            $('#file_uploadFamliy').uploadifive('clearQueue');
        }
    }

    $(function () {
        var a = 0;
        $('#file_uploadFamliy').uploadifive({
            'auto': false,
            'fileSizeLimit': '102400KB',
            'buttonText': '浏  览',
            'multi': true,
            'queueID': 'queueFamliy',
            'uploadScript': '/Person/FamilyMemberUpload',
            'formData': { 'ID': '@*@item.ID*@', 'type': 'RelationInsert' },
            'onUploadComplete': function (file, data) {
                a = a + 1;
                if ($("#queueFamliy").children().length - a == 0) {
                    checkCancelFamliy();
                    a = 0;
                }
                unload();
            }
        });
    });
    var spinner;
    function loading() {
        $("#myMasksText").html("正在导入，请稍等");
        $("#myMasks").fadeIn(300);
        var height = $(window).height() + "px";
        $("#myMasks").height($(window).height());
        //
        $("#ai").css("top", $(window).height() / 2 - 100);
        var opts = {
            lines: 13, //The number of lines to draw   菊花瓣的数目
            length: 7, //The length of each line   菊花瓣的长度
            width: 4, //The line thickness   菊花瓣的宽度
            radius: 10, //The radius of the inner circle   菊花中心的半径
            corners: 1, //Corner roundness (0..1)   菊花瓣的圆滑度(0--1)
            rotate: 0, //The rotation offset   让菊花旋转的角度
            color: '#fff', //#rgb or #rrggbb   菊花的颜色
            speed: 1, //Rounds per second   菊花旋转的速度
            trail: 60, //Afterglow percentage   菊花旋转时的余辉
            shadow: false, //Whether to render a shadow   是否需要菊花的阴影
            hwaccel: false, //Whether to use hardware acceleration   是否需要菊花高速旋转(硬件加速)
            className: 'spinner', //The CSS class to assign to the spinner   菊花的classname
            zIndex: 2e9, //The z-index (defaults to 2000000000)   菊花的z-index值
            top: 'auto', //Top position relative to parent in px   菊花相对定位的top
            left: 'auto' //Left position relative to parent in px  菊花相对定位的left
        };
        var target = document.getElementById('foo');
        spinner = new Spinner(opts).spin(target);
    }
    function unload() {
        spinner.stop();
        $("#myMasksText").html("导入成功");
        setTimeout(function () {
            $("#myMasks").fadeOut(300);
        }, 500);
    }
    //弹出详情
    function myclose() {
        layer.close(index);
        $("#diejiayemian").attr("src", "");
        // queryDataGrid();
    }
    var index;
    function Edit(ID) {
        //$('#diejia').modal();
        var title = "个人信息";
        var src
        if (ID != "") {
            src = '/Person/Edit?ID=' + ID + '&Type=Edit';
        } else {
            src = '/Person/PersonCreate';
        }
       index =  layer.open({
            type: 2,
            title: title,
            shadeClose: true,
            shade: false,
            maxmin: true, //开启最大化最小化按钮
            area: ['100%', '100%'],
            content: src
        });
        //$("#diejiayemian").attr("src", src);
    }


    $.ajax({
        url: "/Person/GetUnit",
        type: "post",
        success: function (data) {
            $("#UnitSelect").select2({
                data: data,
                placeholder: "请选择单位地区"
            });
        }
    });
    function clearselect() {
        $("#UnitSelect").val(null).trigger("change");

        $("#demoList").find("tr").remove();
        $("#testListAction").attr('disabled', false);

    }
    layui.use('upload', function () {
        var $ = layui.jquery
            , upload = layui.upload;
        //演示多文件列表
        var files;
        var demoListView = $('#demoList');
        var uploadListIns = upload.render({
            elem: '#testList'
            , url: '/Person/Upload'
            , accept: 'file'
            , multiple: true
            , number: 0
            , method: 'post'  //可选项。HTTP类型，默认post
            , exts: "doc|docx|xls|xlsx|pdf"
            , auto: false
            , bindAction: '#testListAction'
            , before: function (obj) {
                this.data = {
                    'UnitID': $("#UnitSelect").val(),
                };
            }
            , choose: function (obj) {
                console.log($("#UnitSelect").val());
                if ($("#UnitSelect").val() == null) {
                    layer.msg("请先选择");
                    return false;
                }

                files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
                //读取本地文件
                obj.preview(function (index, file, result) {
                    var tr = $(['<tr id="upload-' + index + '">'
                        , '<td>' + file.name + '</td>'
                        , '<td>' + (file.size / 1014).toFixed(1) + 'kb</td>'
                        , '<td>等待上传</td>'
                        , '<td>'
                        , '<button class="layui-btn layui-btn-mini demo-reload layui-hide">重传</button>'
                        , '<button class="layui-btn layui-btn-mini layui-btn-danger demo-delete">删除</button>'
                        , '</td>'
                        , '</tr>'].join(''));

                    //单个重传
                    tr.find('.demo-reload').on('click', function () {
                        obj.upload(index, file);
                    });

                    //删除
                    tr.find('.demo-delete').on('click', function () {
                        delete files[index]; //删除对应的文件
                        tr.remove();
                        uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                    });

                    demoListView.append(tr);

                });
            }
            , done: function (res, index, upload) {
                var data = res;
                console.log(data);
                var str = "";
                str += "<h4>新增: " + data.New + ", 更新: " + data.Update + "</h4><br>";

                var table = "";
                var table2 = "";
                if (data.New > 0) {
                    table += "<div style='float:left'><table class='table table-bordered'><tr><th colspan='2'>新增</th></tr>";
                    for (var i = 0; i < data.NewPerson.length; i++) {
                        var obj = data.NewPerson[i];
                        table += "<tr><td>" + obj.Name + "</td><td>" + obj.IdCard + "</td></tr>";

                    }
                    table += "</table></div>";

                }


                if (data.Update > 0) {
                    table2 += "<div style='float:left'><table class='table table-bordered'><tr><th colspan='2'>更新</th></tr>";
                    for (var i = 0; i < data.UpdatePerson.length; i++) {
                        var obj = data.UpdatePerson[i];
                        table2 += "<tr><td>" + obj.Name + "</td><td>" + obj.IdCard + "</td></tr>";

                    }
                    table2 += "</table></div>";

                }


                layer.alert(str + table + table2, { offset: '100px' });





                if (res.a == 200) { //上传成功
                    var tr = demoListView.find('tr#upload-' + index)
                        , tds = tr.children();
                    tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
                    tds.eq(3).html(''); //清空操作
                    delete this.files[index]; //删除文件队列已经上传成功的文件
                    return;
                }





                this.error(index, upload);
            }
            , allDone: function (obj) {
                queryDataGrid();
                $("#testListAction").attr('disabled', true);
                delete this.files[index]; //删除文件队列已经上传成功的文件


            }
            , error: function (index, upload) {
                console.log(index);
                var tr = demoListView.find('tr#upload-' + index)
                    , tds = tr.children();
                tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                tds.eq(3).find('.demo-delete').addClass('layui-hide');
                delete this.files[index]; //删除文件队列已经上传成功的文件

            }
        });
    });

    $.ajax({
        url: "/Person/GetUnit",
        type: "post",
        success: function (data) {
            
            $("#qry_Unit").select2({
                data: data,
                placeholder: "请选择单位地区"
            });

            clearselect();
        }
    });
    function clearselect() {
        $("#qry_Unit").val(null).trigger("change");

        $("#demoList").find("tr").remove();
        $("#testListAction").attr('disabled', false);

    }
</script>